<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mantenimiento a Case Module</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <script th:src="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js}"></script>
    <link rel="stylesheet" th:href="@{https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css}">
    <link rel="shortcut icon" th:href="@{/img/kdimg/icono.png}" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/styles.css}">

    <style>
        .navbar-brand img {
            max-height: 48px;
            width: auto;
        }

        .card.module:hover {
            transform: translateY(-4px);
            transition: transform .15s ease;
        }

        body {
            background-color: #292929;
            font-family: 'Montserrat', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';
        }
    </style>

</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-danger sticky-top shadow-sm">
        <!-- ZONA DE CONTROLES -->
        <div class="container-fluid">
            <a class="navbar-brand" th:href="@{https://www.promex-logistics.com.mx}">
                <img th:src="@{/img/kdimg/logo.png}" alt="Logo">
            </a>

            <form th:action="@{/kdoffsite}" method="post" id="caseForm"
                class="d-flex flex-column flex-md-row gap-2 w-100"
                onsubmit="document.getElementById('campoFiltro').value = document.getElementById('campoFiltro').value.trim();">
                <!-- Input flotante -->
                <div>
                    <input type="text" class="navbarInput" id="casem" name="casem" th:value="${casem}"
                        placeholder="Case Module" style="text-transform: uppercase;"
                        oninput="this.value = this.value.toUpperCase().trim()">
                </div>

                <!-- Botones principales -->
                <div class="d-flex align-items-center gap-2">
                    <button type="submit" class="btn btn-light">
                        <i class="fa-solid fa-search"></i> Buscar
                    </button>
                </div>
            </form>
        </div>
        <!-- Botones secundarios -->
        <div class="d-flex align-items-center gap-2">
            <button type="button" class="btn btn-light" onclick="limpiarBusqueda()">
                <i class="fa-solid fa-broom"></i> Limpiar
            </button>
            <button type="button" class="btn btn-light" onclick="actualizarTablasConFiltro()">
                <i class="fa-solid fa-arrows-rotate"></i> Actualizar
            </button>
            <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#modalBaja">
                <i class="fa-solid fa-ban"></i> Baja
            </button>
            <button type="button" class="btn btn-light" id="editarBtnKD" title="Editar">
                <i class="fa-solid fa-pen-to-square"></i> Editar
            </button>
            <button type="button" class="btn btn-eliminar" data-bs-toggle="modal" data-bs-target="#modalEliminar"
                th:data-id="${casem}">
                <i class="fa-solid fa-trash"></i> Eliminar
            </button>
            <a th:href="@{/modulos}" class="btn btn-light" onclick="cerrarVentana(); return false;">
                <i class="fa-solid fa-arrow-left"></i> Regresar </a>
        </div>
    </nav>

    <!-----------------------------------
                        TABLAS
    ------------------------------------->

    <div class="layout-wrapper">

        <!-- Overlay de carga -->
        <div id="overlay-cargando" class="overlay-cargando d-none">
            <div class="overlay-contenido">
                <div class="spinner"></div>
                <p>Cargando...</p>
            </div>
        </div>

        <!-- Card de Error -->
        <div th:if="${error}" class="card bg-dark border-danger mt-3" style="max-width: 500px; margin: auto;"
            id="card-error">
            <div class="card-body text-danger">
                <h5 class="card-title">Error</h5>
                <p class="card-text" th:text="${error}"></p>
            </div>
        </div>

        <!-- Card de Éxito -->
        <div th:if="${mensaje}" class="card bg-dark border-success mt-3" style="max-width: 500px; margin: auto;"
            id="card-mensaje">
            <div class="card-body text-success">
                <h5 class="card-title">Éxito</h5>
                <p class="card-text" th:text="${mensaje}"></p>
            </div>
        </div>

        <!-- Columna izquierda (Tabla 1) -->
        <div class="col-izq">
            <div class="table-wrapper">
                <!-- Tabla 1 -->
                <div class="table-header-title">
                    PFYSTICHP
                </div>
                <div class="table-wrapper" id="tabla-pfystichp">
                    <div th:replace="~{fragments/kdoffsite/tabla-pfystichp :: tablaPfystichp}"></div>
                </div>
                <div th:if="${casem != null and casem != '' and #lists.isEmpty(pfystichp)}">
                    <script>
                        document.addEventListener("DOMContentLoaded", function () {
                            var myModal = new bootstrap.Modal(document.getElementById('noResultsModal'));
                            myModal.show();
                        });
                    </script>
                </div>
            </div>
        </div>

        <!-- Segunda columna -->
        <div class="col-der">
            <!-- Tabla 2 -->
            <div class="table-header-title">
                PFYSTIHP
            </div>
            <div class="table-wrapper" id="tabla-pfystihp">
                <div th:replace="~{fragments/kdoffsite/tabla-pfystihp :: tablaPfystihp}"></div>
            </div>
            <!--  Tabla 3  -->
            <div class="table-header-title">
                PFCCASNK
            </div>
            <div class="table-wrapper" id="tabla-pfccasnk">
                <div th:replace="~{fragments/kdoffsite/tabla-pfccasnk :: tablaPfccasnk}"></div>
            </div>
            <!--  Tabla 4  -->
            <div class="table-header-title">
                PFOASNDCP
            </div>
            <div class="table-wrapper" id="tabla-pfoasndcp">
                <div th:replace="~{fragments/kdoffsite/tabla-pfoasndcp :: tablaPfoasndcp}"></div>
            </div>
        </div>

    </div>


    <!-----------------------------------
                    FOOTER
    ------------------------------------->

    <footer class="footer bg-danger text-white text-center py-3 mt-auto footer">
        <div class="container">
            © Copyright 2025 <strong>Promex Logistics S. de R.L. de C.V.</strong> Derechos reservados.
        </div>
    </footer>


    <!-----------------------------------
                    MODALS
    ------------------------------------->

    <!-- Modal para "No se encontraron resultados" -->
    <div class="modal fade" id="noResultsModal" tabindex="-1" aria-labelledby="noResultsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center modal-kd border-danger">
                <div class="modal-header">
                    <h5 class="modal-title" id="noResultsModalLabel"><strong> Sin resultados </strong></h5>
                </div>
                <div class="modal-body" style="color: #fff;">
                    No se encontraron resultados para el Case Module ingresado: <strong th:text="${casem}"></strong>.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal para editar -->
    <div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="modalEditarLabel"><strong> Editar KD </strong></h5>
                </div>
                <div class="modal-body">
                    <form id="form-editar" th:action="@{/kdoffsite/editar-pfystichp}" method="post">
                        <div class="mb-3">
                            <label for="inputCaseModule" class="form-label">Case Module:</label>
                            <input type="text" class="form-control" id="inputCaseModule" name="casem" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="inputCaseLocation" class="form-label">Ubicación:</label>
                            <input type="text" class="form-control" id="inputCaseLocation" name="newTcloc">
                        </div>
                        <div class="mb-3">
                            <label for="inputCaseStatus" class="form-label">Estado:</label>
                            <select class="form-select" id="inputCaseStatus" name="newTcsts">
                                <option value=" ">---</option>
                                <option value="R">R</option>
                                <option value="P">P</option>
                                <option value="DP">DP</option>
                                <option value="DC">DC</option>
                            </select>
                        </div>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-danger" id="btnGuardarCambios">Guardar cambios</button>
                            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar 2 -->
    <div class="modal fade" id="modalEditarASN" tabindex="-1" aria-labelledby="modalEditarASNLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="modalEditarASNLabel"><strong> Cambio de estado </strong></h5>
                </div>
                <div class="modal-body">
                    <form id="form-editarASN" th:action="@{/kdoffsite/editar-pfystihp}" method="post">
                        <div class="mb-3">
                            <label for="inputASN" class="form-label">ASN:</label>
                            <input type="text" class="form-control" id="inputASN" name="thasn" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="inputEstado" class="form-label">Estado:</label>
                            <select class="form-select" id="inputEstado" name="newThsts">
                                <option value="2">2 — Activar</option>
                                <option value="6">6 — Bloquear</option>
                            </select>
                        </div>
                        <input type="hidden" id="hiddenCasemASN" name="casem">
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-danger" id="btnGuardarCambios">Guardar cambios</button>
                            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Baja -->
    <div class="modal fade" id="modalBaja" tabindex="-1" aria-labelledby="modalBajaLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white border-secondary">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="modalBajaLabel">Confirmar baja</h5>
                </div>
                <div class="modal-body">
                    <p>¿Deseas dar de baja el <strong>Case Module</strong> ingresado?</p>
                    <input type="text" class="form-control" id="casemBaja" name="casem" readonly>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-red" id="btnConfirmarBaja">Confirmar Baja</button>
                    <button type="button" class="btn-red" data-bs-dismiss="modal">Cancelar</button>

                </div>
            </div>
        </div>
    </div>

    <!-- Modal Confirmación Eliminar -->
    <div class="modal fade" id="modalEliminar" tabindex="-1" aria-labelledby="modalEliminarLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white border-danger">
                <div class="modal-header">
                    <h5 class="modal-title text-danger" id="modalEliminarLabel">Confirmar Eliminación</h5>
                </div>
                <div class="modal-body">
                    <p>¿Eliminar el case module <strong th:text="${casem}"></strong>?</p>
                </div>
                <div class="modal-footer">
                    <form id="formConfirmarEliminar" th:action="@{/kdoffsite/eliminar}" method="post">
                        <input type="hidden" name="casem" id="casem" />
                        <button type="submit" class="btn-red">Eliminar</button>
                        <button type="button" class="btn-red" data-bs-dismiss="modal">Cancelar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>



    <!-------------------------------------------------------
                    ACCIONES PARA LOS BOTONES DE CONTROLES
        --------------------------------------------------------->
    <!-- Botón para limpiar -->
    <script>
        function limpiarBusqueda() {
            // Limpiar input
            const inputCasem = document.getElementById("casem");
            inputCasem.value = "";

            // Limpiar contenido de las tablas
            const tablas = document.querySelectorAll("tbody.table-dark");
            tablas.forEach(t => t.innerHTML = "");

            // Habilitar botón de editar
            const btnEditar = document.getElementById("editarBtnKD");
            if (btnEditar) {
                btnEditar.disabled = false;                 // Habilita el botón
                btnEditar.classList.add("btn-light");       // Estilo normal
                btnEditar.classList.remove("btn-secondary"); // Quita estilo deshabilitado
            }

            // Restaurar la función de doble clic para editar ASN
            if (typeof activarDobleClickPFYSTIHP === "function") {
                // Si ya estaba definida, podemos reactivar la original
                activarDobleClickPFYSTIHP(); // O simplemente dejarla lista para nuevo CASE
            }
        }
    </script>


    <!-- Botón para actualizar -->
    <script>
        function actualizarTablasConFiltro() {
            const caseModule = document.getElementById("casem").value;
            if (!caseModule) {
                console.warn("No hay case module ingresado.");
                return;
            }

            const tablas = [
                { id: "tabla-pfystichp", url: "kdoffsite/tabla-pfystichp" },
                { id: "tabla-pfystihp", url: "kdoffsite/tabla-pfystihp" },
                { id: "tabla-pfccasnk", url: "kdoffsite/tabla-pfccasnk" }
            ];

            tablas.forEach(tabla => {
                fetch(`${tabla.url}?casem=${encodeURIComponent(caseModule)}`)
                    .then(resp => resp.text())
                    .then(html => {
                        document.getElementById(tabla.id).innerHTML = html;
                        console.log(`Tabla "${tabla.id}" actualizada con éxito.`);
                    })
                    .catch(err => {
                        console.error(`Error al actualizar ${tabla.id}:`, err);
                    });
            });
        }
    </script>



    <!-----------------------------------
                    CARGAR TABLAS
        ------------------------------------->
    <script>
        let casemActual = null;
        function cargarTablas(fila) {
            const caseModule = fila.getAttribute("data-casem");
            casemActual = caseModule;

            if (!caseModule) {
                console.warn("⚠️ No se encontró case module en la fila seleccionada.");
                return;
            }

            //Cargar tabla PFYSTIHP

            fetch(`kdoffsite/tabla-pfystihp?casem=${encodeURIComponent(caseModule)}`)
                .then(resp => {
                    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                    return resp.text();
                })
                .then(html => {
                    document.getElementById("tabla-pfystihp").innerHTML = html;
                    console.log(`Tabla PFYSTIHP actualizada para case: ${caseModule}`);

                    // Aquí activamos el doble clic justo después de cargar
                    activarDobleClickPFYSTIHP();
                })
                .catch(err => {
                    console.error("Error al cargar la tabla PFYSTIHP:", err);
                });

            //Cargar tabla PFCCASNK

            fetch(`kdoffsite/tabla-pfccasnk?casem=${encodeURIComponent(caseModule)}`)
                .then(resp => {
                    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                    return resp.text();
                })
                .then(html => {
                    document.getElementById("tabla-pfccasnk").innerHTML = html;
                    console.log(`Tabla PFCCASNK actualizada para case: ${caseModule}`);
                })
                .catch(err => {
                    console.error("Error al cargar la tabla PFCCASNK:", err);
                });
        }
    </script>


    <script>
        function cargarDetallePFOASNDCP(fila) {
            const boxSerialNo = fila.getAttribute('data-boxserial');
            const partNumber = fila.getAttribute('data-part');

            if (!boxSerialNo || !partNumber) {
                console.warn("No se encontró 'boxSerialNo' o 'partNumber'. Petición cancelada.");
                return;
            }

            fetch(`/kdoffsite/tabla-pfoasndcp?boxSerialNo=${encodeURIComponent(boxSerialNo)}&partNumber=${encodeURIComponent(partNumber)}`)
                .then(response => response.text())
                .then(html => {
                    document.querySelector('#tabla-pfoasndcp').innerHTML = html;
                })
                .catch(error => console.error('Error al cargar la tabla PFOASNDCP:', error));
        }

    </script>



    <!---------------------------------------------
                    CARGAR DATOS PARA EDITAR
        ----------------------------------------------->
    <!-- Editar KD — Tabla PFYSTICHP -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const editarBtnKD = document.querySelector("button[title='Editar']");
            const tablaPfystichp = document.querySelector("#tabla-pfystichp table");

            editarBtnKD.addEventListener("click", function () {
                if (!tablaPfystichp) {
                    console.warn("No se encontró la tabla 'tabla-pfystichp'");
                    return;
                }

                const primeraFila = tablaPfystichp.querySelector("tbody tr");
                if (!primeraFila) {
                    console.warn("La tabla está vacía");
                    return;
                }

                const celdas = primeraFila.querySelectorAll("td");

                // Asignar datos de las celdas a los inputs del modal
                // Asegurar de que el orden corresponda con los campos
                document.getElementById("inputCaseModule").value = celdas[5]?.textContent.trim() || "";
                document.getElementById("inputCaseLocation").value = celdas[3]?.textContent.trim() || "";
                document.getElementById("inputCaseStatus").value = celdas[4]?.textContent.trim() || "";

                const modal = new bootstrap.Modal(document.getElementById('modalEditar'));
                modal.show();
            });
        });


    </script>

    <!-- Editar estado — Tabla PFYSTIHP -->

    <script>
        function activarDobleClickPFYSTIHP() {
            const tabla = document.querySelector("#tabla-pfystihp table");

            if (!tabla) {
                console.warn("Tabla PFYSTIHP no encontrada para el doble clic.");
                return;
            }

            tabla.addEventListener("dblclick", function (e) {
                const fila = e.target.closest("tr");
                if (!fila) return;

                const celdas = fila.querySelectorAll("td");

                // Asignar valores al modal (ajusta los índices según tus columnas)
                document.getElementById("inputASN").value = celdas[2]?.textContent.trim() || "";
                document.getElementById("inputEstado").value = celdas[9]?.textContent.trim() || "";

                document.getElementById("hiddenCasemASN").value = casemActual;

                const modal = new bootstrap.Modal(document.getElementById('modalEditarASN'));
                modal.show();
            });
        }
    </script>


    <!-----------------------------------
                    JS GRALES
        ------------------------------------->

    <script>
        window.addEventListener("DOMContentLoaded", () => {
            // Si hay parámetro en la URL, y es un reload, quitamos el parámetro visualmente
            if (window.location.href.includes("casem=")) {
                // Esto borra los parámetros pero no recarga la página
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const input = document.getElementById("casem");

            input.addEventListener("input", function () {
                this.value = this.value.toUpperCase();
            });
        });
    </script>

    <!-- Script para Overlay cargando -->
    <script>
        function mostrarOverlay() {
            document.getElementById('overlay-cargando').classList.remove('d-none');
        }

        document.addEventListener("DOMContentLoaded", function () {
            const forms = document.querySelectorAll("form");
            forms.forEach(form => {
                form.addEventListener("submit", function () {
                    mostrarOverlay();
                });
            });
        });
    </script>


    <!-- Script para baja -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const modalBaja = document.getElementById("modalBaja");
            const inputCasem = document.getElementById("casem");
            const inputCasemBaja = document.getElementById("casemBaja");
            const btnConfirmarBaja = document.getElementById("btnConfirmarBaja");

            // Al abrir el modal, llenar el campo con el Case Module actual
            modalBaja.addEventListener("show.bs.modal", () => {
                inputCasemBaja.value = inputCasem.value.trim();
            });

            // Cuando el usuario confirma la baja
            btnConfirmarBaja.addEventListener("click", async () => {
                const casem = inputCasemBaja.value.trim();
                if (!casem) {
                    alert("Por favor ingresa un Case Module antes de continuar.");
                    return;
                }

                try {
                    mostrarOverlay(); // Muestra el overlay “Cargando...”

                    // 🔹 Llamada al endpoint que ejecuta la baja
                    const response = await fetch(`/kdoffsite/baja?casem=${encodeURIComponent(casem)}`, {
                        method: "POST"
                    });

                    if (!response.ok) throw new Error(`Error HTTP ${response.status}`);

                    // 🔹 Esperar el mensaje del servidor
                    const result = await response.text();
                    console.log("Resultado de la baja:", result);

                    // 🔹 Cerrar modal
                    const modal = bootstrap.Modal.getInstance(modalBaja);
                    modal.hide();

                    // 🔹 Mostrar mensaje de confirmación
                    alert("✅ Baja ejecutada correctamente.");

                    // 🔹 Actualizar las tablas
                    actualizarTablasConFiltro();
                } catch (err) {
                    console.error("Error al ejecutar la baja:", err);
                    alert("Ocurrió un error al realizar la baja.");
                } finally {
                    document.getElementById('overlay-cargando').classList.add('d-none');
                }
            });
        });
    </script>

    <!-- Script para eliminar -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const modalEliminar = document.getElementById("modalEliminar");
            const inputHidden = modalEliminar.querySelector("input[name='casem']");

            modalEliminar.addEventListener("show.bs.modal", function (event) {
                const button = event.relatedTarget; // Botón que abrió el modal
                const casem = button.getAttribute("data-id"); // Obtener el case module
                inputHidden.value = casem; // Pasarlo al input hidden
            });
        });
    </script>


    <!-- Script para consultar el estado -->
    <script>
        document.addEventListener("DOMContentLoaded", async function () {
            const casem = document.getElementById("casem").value.trim();
            const btnEditar = document.getElementById("editarBtnKD");
            if (!casem || !btnEditar) return;

            try {
                const resp = await fetch(`/kdoffsite/estado-case?casem=${encodeURIComponent(casem)}`);
                if (!resp.ok) throw new Error("Error al consultar el estado");
                const estado = (await resp.text()).trim();

                console.log("Estado del CASE:", estado);

                if (estado === "DC") {
                    // Deshabilitar botón de editar
                    btnEditar.disabled = true; // Esto es más directo
                    btnEditar.classList.add("btn-secondary"); // Cambia estilo
                    btnEditar.classList.remove("btn-light");   // Opcional: quitar estilo normal

                    // Desactiva doble clic para editar ASN
                    window.activarDobleClickPFYSTIHP = function () {
                        console.log("Edición desactivada porque el CASE está en DC");
                    };
                } else {
                    // En cualquier otro caso, aseguramos que esté habilitado
                    btnEditar.disabled = false;
                    btnEditar.classList.add("btn-light");
                    btnEditar.classList.remove("btn-secondary");
                }
            } catch (err) {
                console.error("Error consultando estado:", err);
            }
        });
    </script>

    <script>
        function cerrarVentana() {
            // Intenta cerrar la pestaña
            window.close();

            // Si no se cierra, redirige (por ejemplo, al menú)
            setTimeout(() => {
                if (!window.closed) {
                    window.location.href = '/modulos';
                }
            }, 200);
        }
    </script>

</body>

</html>